<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>动态详情</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0 user-scalable=no" />
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="../../css/api.css">
    <link rel="stylesheet" href="../../css/public.css">
    <link rel="stylesheet" href="../../css/DynamicDetails.css" />
</head>

<body>
    <div id="body">
        <!--浮动底部-->
        <ul class="DynamicDetailsBot">
            <!-- <li id="fengxiang">
            <div>
                <img src="../../images/SquarePL_03.png">
            </div>
        </li> -->
            <li id="pinlun">
                <div>
                    <img src="../../images/SquarePL_05.png">
                </div>
            </li>
            <li id="dianzan">
                <div>
                    <img src="../../images/SquarePL_07.png">
                </div>
            </li>
        </ul>




        <div class="roofS">
            <div class="roof">
                <div class="roofReturn"></div>
                <!-- <div class="roofSearch"></div>
        <div class="roofMessage messageU"></div> -->
                <div class="roofConter">
                    官方活动
                </div>
            </div>
        </div>
        <div class="roofSDiv"></div>
        <div class="Vdetails">

        </div>

        <!--动态详情导航-->
        <ul class="DynamicDetailsNvn">
            <li id="DynamicDetailsNvnL" data-DDNId="Comment">
                <P class="p1"></P>
                <ul class="DynamicDetailsNvnW">
                    <li class="DynamicDetailsNvnWL">
                        <img src="../../images/SquarePL_05.png" />
                    </li>
                    <li id="pinluncount" class="DynamicDetailsNvnWR">
                        0
                    </li>
                </ul>
            </li>
            <li data-DDNId="Attention">
                <P class="p1"></P>
                <ul class="DynamicDetailsNvnW">
                    <li class="DynamicDetailsNvnWL">
                        <img src="../../images/SquarePL_07.png" />
                    </li>
                    <li id="dianzancount" data-id="dianzancount" class="DynamicDetailsNvnWR">
                        0
                    </li>
                </ul>
            </li>
        </ul>
        <!--评论详情列表-->
        <div id="Comment" class="DetailsList">

        </div>
        <!--关注详情列表-->
        <div id="Attention" class="DetailsList">

        </div>
        <P class="DDetailsB"></P>
    </div>
    <script type="text/javascript" src="../../script/api.js"></script>
    <script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="../../script/config.js"></script>
    <script type="text/javascript" src="../../script/doT.min.js"></script>
    <script type="text/javascript" src="../../script/util.js"></script>
    <script type="text/javascript" src="../../script/PublicCss.js"></script>

    <script type="text/javascript">
        var pinlunPageSize = 5,
            pinlunPageNum = 1,
            pinlunHasNext = true;
        var dianzanPageSize = 5,
            dianzanPageNum = 1,
            dianzanHasNext = true;
        var type = "pinlun";
        var squreid = "";
        var userid = "";
        var momentid = "";
        var commentList = []
        apiready = function () {
            $api.fixStatusBar($api.dom('.roofS'));

            // 列表距顶部距离
            var systemType = api.systemType;
            if (systemType == "android") {
                $(".roofSDiv").css("height", "" + ($(".roofS").height() + 30) + "px");
            }
            if (systemType == "ios") {
                $(".roofSDiv").css("height", "" + ($(".roofS").height() + 40) + "px");
            }

            $api.setStorage('openWin', "DynamicDetails");
            //返回箭头事件
            $(".roofReturn").click(function () {
                api.closeWin({});
            });

            var squreid = api.pageParam.squreid,
                userid = api.pageParam.userid,
                momentid = api.pageParam.momentid,
                activeId = api.pageParam.activeId;
            api.ajax({
                    url: CONFIG.ADDRURL + CONFIG.GFHDXQ,
                    method: 'post',
                    data: {
                        values: {
                            activity_id: momentid,
                            user_id: $api.getStorage('userid'),
                        }
                    }
                },
                function (data, err) {
                    console.log(JSON.stringify(data))
                    if (data.code == "200") {
                        // console.log(JSON.stringify(data.ActivityComments.list[0]))
                        var img = $("<div>").html(data.ActivityCommentDetail.activity_content).find('img:eq(0)')
                            .attr('src')
                        if (img) {
                            if (img.length == 0) {
                                data.ActivityCommentDetail.img = '../../images/gfhdImg.png'
                            } else {
                                data.ActivityCommentDetail.img = img
                            }
                        }
                        var tempFn = doT.template($api.byId('Vdetails').innerHTML);
                        var resultHTML = tempFn(data.ActivityCommentDetail);
                        $(".Vdetails").append(resultHTML);
                    }
                });

            //滑动关闭
            api.addEventListener({
                name: 'swiperight'
            }, function (ret, err) {
                api.closeWin({
                    name: 'GFHDDetails'
                });
            });

            squreid = api.pageParam.squreid;
            userid = api.pageParam.userid;
            momentid = api.pageParam.momentid;
            photosListener();
            if (userid == $api.getStorage('userid')) {
                $(".DynamicDetailsTopR").hide();
            } else {
                isfans(userid);
            }
            // getcomentslist(momentid, 5, 1, false);
            isdianzan(momentid);
            getdianzan(momentid, dianzanPageSize, dianzanPageNum, true, function (data) {
                $('[data-id="dianzancount"]').text(data)
            });
            //动态详情导航
            $(".DynamicDetailsNvn li").click(function () {
                $(".DynamicDetailsNvn li").attr("id", "");
                $(this).attr("id", "DynamicDetailsNvnL");
                $(".DetailsList").css("display", "none");
                $("#" + $(this).attr("data-DDNId") + "").css("display", "block");
                if ($(this).attr("data-DDNId") == "Comment") {
                    type = "pinlun";
                } else if ($(this).attr("data-DDNId") == "Attention") {
                    type = "dianzan";
                }
            });
            //列表底部
            $(".DDetailsB").css("height", "" + $(".DynamicDetailsBot").height() + "px");
            getcomentslist(momentid, pinlunPageSize, pinlunPageNum, false);
            api.addEventListener({
                name: 'scrolltobottom',
                extra: {
                    threshold: 0 //设置距离底部多少距离时触发，默认值为0，数字类型
                }
            }, function (ret, err) {
                if (type == "pinlun") {
                    if (pinlunHasNext) {
                        getcomentslist(momentid, pinlunPageSize, pinlunPageNum, false);
                    }
                } else if (type == "dianzan") {
                    if (dianzanHasNext) {
                        getdianzan(momentid, dianzanPageSize, dianzanPageNum, false);
                    }
                }
            });
            //参与活动
            $('.Vdetails').on("click", ".VenjoyBtn", function () {
                if (!checklogin()) {
                    return false;
                }
                var activityId = $(this).attr("activityId");
                var user_id = $api.getStorage('userid');
                if (!activityId) {
                    return false;
                }
                api.ajax({
                        url: CONFIG.ADDRURL + CONFIG.CYHD,
                        method: 'post',
                        data: {
                            values: {
                                activity_id: activityId,
                                user_id: user_id
                            }
                        }
                    },
                    function (data) {
                        if (data.code == 200) {
                            api.toast({
                                msg: data.msg,
                                duration: 1000,
                                location: 'middle'
                            });
                            $(".VenjoyBtn").html("报名成功")
                        }
                        // console.log(JSON.stringify(data))

                    });
            })
            // 分享
            $('.Vdetails').on("click", ".share", function () {

                var activityId = $('.share').attr("activityId");
                if (!activityId) {
                    return false;
                }
                api.openFrame({
					name: 'share',
					url: './share.html',
					rect: {
						x: 0,
						y: api.winHeight - 200,
						w: api.winWidth,
						h: 200
					},
					animation: {
						type: "push", //动画类型（详见动画类型常量）
						subType: "from_bottom", //动画子类型（详见动画子类型常量）
						duration: 300 //动画过渡时间，默认300毫秒
					},
					pageParam: {
                        activityId: activityId,
                        img:$('.VdetailsOneLeftImg').attr('src'),
                        title: $('.VdetailsOneRightOne').text()
					}
				});
            })

            // 进入个人主页
            $("#Comment,#Attention,.DynamicDetailsTop").on("click", ".otherspage", function () {
                var userid = $(this).attr("userid");
                api.openWin({
                    name: 'otherspage',
                    url: '../otherspage.html',
                    rect: {
                        x: 0,
                        y: 0,
                        w: 'auto',
                        h: 'auto'
                    },
                    pageParam: {
                        userid: userid
                    },
                    animation: {
                        type: "push", //动画类型（详见动画类型常量）
                        subType: "from_right", //动画子类型（详见动画子类型常量）
                        duration: 300 //动画过渡时间，默认300毫秒
                    }
                });
            });

            $("#pinlun").click(function () {
                if (!checklogin()) {
                    return false;
                }
                var UIChatBox = api.require('UIChatBox');
                UIChatBox.open({
                    autoFocus: true,
                    emotionPath: "widget://res/image/emotion",
                    texts: {
                        sendBtn: {
                            title: '发送'
                        }
                    },
                    styles: {
                        inputBar: {
                            borderColor: '#d9d9d9',
                            bgColor: '#f2f2f2'
                        },
                        inputBox: {
                            borderColor: '#B3B3B3',
                            bgColor: '#FFFFFF'
                        },
                        indicator: {
                            target: 'both',
                            color: '#c4c4c4',
                            activeColor: '#9e9e9e'
                        },
                        sendBtn: {
                            bg: '#4cc518',
                            titleColor: '#ffffff',
                            activeBg: '#46a91e',
                            titleSize: 13
                        }
                    }
                }, function (ret, err) {
                    if (ret.eventType == "send") {
                        if (ret.msg == null || ret.msg == "") {
                            api.toast({
                                msg: "评论内容不能为空！",
                                duration: 1000,
                                location: 'middle'
                            });
                        } else {
                            api.ajax({
                                    url: CONFIG.ADDRURL + CONFIG.COMMENT,
                                    method: 'post',
                                    data: {
                                        values: {
                                            passiveuserid: userid,
                                            userid: $api.getStorage('userid'),
                                            activityid: momentid,
                                            commentcontent: ret.msg,
                                            commenttype: 2,
                                            isOffical: 1
                                        }
                                    }
                                },
                                function (data) {
                                    if (data.code = "200") {
                                        // getsquredetail(squreid);
                                        getcomentslist(momentid, pinlunPageSize, 1, true);
                                        window.location.hash = "#"

                                    }
                                });
                            UIChatBox.close();
                        }
                    }
                });
            });

            //子评论
            $("#Comment").on("click", ".zipinlun", function () {
                if (!checklogin()) {
                    return false;
                }
                var activityid = $(this).attr("commentid");
                var pid = $(this).attr("replyid");
                var comment = $(this).attr("comment");
                // console.log(ret.msg)

                var UIChatBox = api.require('UIChatBox');
                UIChatBox.open({
                    autoFocus: true,
                    emotionPath: "widget://res/image/emotion",
                    texts: {
                        sendBtn: {
                            title: '发送'
                        }
                    },
                    styles: {
                        inputBar: {
                            borderColor: '#d9d9d9',
                            bgColor: '#f2f2f2'
                        },
                        inputBox: {
                            borderColor: '#B3B3B3',
                            bgColor: '#FFFFFF'
                        },
                        indicator: {
                            target: 'both',
                            color: '#c4c4c4',
                            activeColor: '#9e9e9e'
                        },
                        sendBtn: {
                            bg: '#4cc518',
                            titleColor: '#ffffff',
                            activeBg: '#46a91e',
                            titleSize: 13
                        }
                    }
                }, function (ret, err) {
                    if (ret.eventType == "send") {
                        if (ret.msg == null || ret.msg == "") {
                            api.toast({
                                msg: "评论内容不能为空！",
                                duration: 1000,
                                location: 'middle'
                            });
                        } else {
                            // alert(123)
                            // console.log(activityid)
                            // console.log(pid)
                            // console.log("userid"+$api.getStorage('userid'))
                            // console.log(ret.msg)
                            api.ajax({
                                    url: CONFIG.ADDRURL + CONFIG.COMMENT,
                                    method: 'post',
                                    data: {
                                        values: {
                                            isOffical: 1,
                                            activityid: activityid,
                                            pid: pid,
                                            userid: $api.getStorage('userid'),
                                            commentcontent: ret.msg,
                                            commenttype: 2
                                        }
                                    }
                                },
                                function (data) {
                                    // console.log(JSON.stringify(data))
                                    if (data.code = "200") {
                                        getcomentslist(momentid, pinlunPageSize, 1, true);
                                        window.location.hash = "#"
                                    }
                                });
                            UIChatBox.close();
                        }
                    }
                });
            });

            //关闭窗口
            $('body').on('touchstart', function (e) {
                var UIChatBox = api.require('UIChatBox');
                UIChatBox.close();
            });

            //点赞按钮
            $("#dianzan").click(function () {
                if (!checklogin()) {
                    return false;
                }
                var dianzan = $(this).find("img");
                if ($(dianzan).attr("isdianzan") == "true") {
                    var json = {
                        passiveuserid: userid,
                        activityid: momentid,
                        userid: $api.getStorage('userid'),
                        commenttype: 1,
                        isOffical: 1
                    }
                    console.log(JSON.stringify(json))
                    api.ajax({
                            url: CONFIG.ADDRURL + CONFIG.DELETECOMMENT,
                            method: 'post',
                            data: {
                                values: json
                            }
                        },
                        function (data, err) {
                            console.log(JSON.stringify(data))
                            if (data.code == "200") {
                                $(dianzan).attr("src", "../../images/SquarePL_07.png").attr("isdianzan",
                                    "false");
                                dianzanPageNum = 1;
                                // isdianzan(momentid)
                                getdianzan(momentid, dianzanPageSize, dianzanPageNum, true, function (
                                    data) {
                                    $('[data-id="dianzancount"]').text(data)
                                })
                                api.sendEvent({
                                    name: 'refreshSquare'
                                });
                            }
                        });
                } else {
                    api.ajax({
                            url: CONFIG.ADDRURL + CONFIG.COMMENT,
                            method: 'post',
                            data: {
                                values: {
                                    activityid: momentid,
                                    passiveuserid: userid,
                                    userid: $api.getStorage('userid'),
                                    commenttype: 1,
                                    commentcontent: "喜欢",
                                    isOffical: 1
                                }
                            }
                        },
                        function (data, err) {
                            if (data.code == "200") {
                                // $(dianzan).attr("src", "../../images/SquarePL_09.png").attr("isdianzan",
                                //     "true");
                                // dianzanPageNum = 1;
                                isdianzan(momentid)
                                getdianzan(momentid, dianzanPageSize, dianzanPageNum, true, function (
                                    data) {
                                    $('[data-id="dianzancount"]').text(data)
                                });
                                api.sendEvent({
                                    name: 'refreshSquare'
                                });
                            }
                        });
                }


            });
            //子点赞按钮
            $("#Comment").on("click", ".zidianzan", function () {
                if (!checklogin()) {
                    return false;
                }
                var dianzan = $(this).find("img");
                var dianzancount = $(this).siblings(".DLURCommentCR");
                var pid = $(this).attr("commentid");
                // console.log(pid)
                if ($(dianzan).attr("isdianzan") == "1") {
                    api.ajax({
                            url: CONFIG.ADDRURL + CONFIG.DELETECOMMENT,
                            method: 'post',
                            data: {
                                values: {
                                    activityid: momentid,
                                    passiveuserid: userid,
                                    userid: $api.getStorage('userid'),
                                    commenttype: 1,
                                    isOffical: 1,
                                    pid: pid

                                }
                            }
                        },
                        function (data, err) {
                            if (data.code == "200") {
                                $(dianzan).attr("src", "../../images/SquarePL_07.png").attr("isdianzan",
                                    "0");
                                $(dianzancount).text($(dianzancount).text() * 1 - 1);
                                // isdianzan(momentid)
                                getdianzan(momentid, dianzanPageSize, dianzanPageNum, true);

                            }
                        });
                } else {
                    api.ajax({
                            url: CONFIG.ADDRURL + CONFIG.COMMENT,
                            method: 'post',
                            data: {
                                values: {
                                    activityid: momentid,
                                    passiveuserid: userid,
                                    userid: $api.getStorage('userid'),
                                    commenttype: 1,
                                    commentcontent: "喜欢",
                                    pid: pid,
                                    isOffical: 1
                                }
                            }
                        },
                        function (data, err) {
                            if (data.code == "200") {
                                $(dianzan).attr("src", "../../images/SquarePL_09.png").attr("isdianzan",
                                    "1");
                                $(dianzancount).text($(dianzancount).text() * 1 + 1);
                                // isdianzan(momentid)
                                getdianzan(momentid, dianzanPageSize, dianzanPageNum, true);
                            }
                        });
                }
            });



            function getsquredetail(id) {
                $(".squrepic").empty();
                api.ajax({
                        url: CONFIG.ADDRURL + CONFIG.GETUERNEWS,
                        method: 'post',
                        data: {
                            values: {
                                id: id,
                                pagesize: 1,
                                pagenum: 1,
                                otheruserid: $api.getStorage('userid')
                            }
                        }
                    },
                    function (data) {
                        if (data.code == "200" && data.community != null && data.community.list != null && data
                            .community.list.length > 0) {
                            $(".DynamicDetailsTopC .p1").html(data.community.list[0].nickname);
                            $(".DynamicDetailsTopC .p2").html(data.community.list[0].createtime);
                            $(".DynamicDetailsTopL img").attr("src", data.community.list[0].avatar == null ||
                                data.community.list[0].avatar == "" ? "../../images/avatar.png" : data
                                .community.list[0].avatar);
                            $(".DynamicDetailsTopL,.DynamicDetailsTopC").addClass("otherspage").attr("userid",
                                data.community.list[0].userid);
                            $(".DynamicDetailsFontSize").html(data.community.list[0].momentcontent);
                            var htmls = "";


                            if (data.community.list[0].pics && data.community.list[0].pics.length == 1) {
                                htmls += "<div class='DynamicDetailsImgOne'>";
                                $.each(data.community.list[0].pics, function (key, val) {
                                    if (val != null && val != "") {
                                        htmls += "<img src='" + val + "?imageView2/1/w/300/h/300'>";
                                    }
                                });
                                htmls += "</div>";
                            } else if (data.community.list[0].pics && data.community.list[0].pics.length == 2) {
                                htmls += "<ul class='DynamicDetailsImgTwo'>";
                                $.each(data.community.list[0].pics, function (key, val) {
                                    if (val != null && val != "") {
                                        htmls += "<li><img src='" + val +
                                            "?imageView2/1/w/300/h/300'></li>";
                                    }
                                });
                                htmls += "</ul>";
                            } else if (data.community.list[0].pics && data.community.list[0].pics.length > 2) {
                                htmls += "<ul class ='DynamicDetailsImg'>";
                                $.each(data.community.list[0].pics, function (key, val) {
                                    if (val != null && val != "") {
                                        htmls += "<li><img src='" + val +
                                            "?imageView2/1/w/300/h/300'></li>";
                                    }
                                });
                                htmls += "</ul>";

                            }
                            $(".squrepic").append(htmls);

                        }
                    });
            };

            //投诉
            $(".report").click(function () {
                var reportId = $(this).attr("activityId")
                api.openWin({
                    name: 'complain',
                    url: '../member/complain.html',
                    rect: {
                        x: 0,
                        y: 0,
                        w: 'auto',
                        h: 'auto'
                    },
                    pageParam: {
                        userid: userid,
                        type: 5,
                        id: reportId
                    },
                    animation: {
                        type: "push", //动画类型（详见动画类型常量）
                        subType: "from_right", //动画子类型（详见动画子类型常量）
                        duration: 300 //动画过渡时间，默认300毫秒
                    }
                });
            });
            // 写真预览监听
            function photosListener() {
                $(".squrepic").on("click", "img", function () {
                    var images = [];
                    var index = 0;
                    if ($(this).parent().hasClass("DynamicDetailsImgOne")) {
                        images.push($(this).attr("src").replace("?imageView2/1/w/300/h/300", ""));
                    } else {
                        index = $(this).parent().index();
                        $(this).parent().parent().find("li").each(function () {
                            images.push($(this).find("img").attr("src").replace(
                                "?imageView2/1/w/300/h/300", ""));
                        });
                    }
                    var photoBrowser = api.require('photoBrowser');
                    photoBrowser.open({
                        images: images,
                        placeholderImg: "",
                        bgColor: '#000'
                    }, function (ret, err) {
                        if (ret.eventType == "show") {
                            api.toast({
                                msg: "长按可以保存图片哦!",
                                duration: 2000,
                                location: 'bottom'
                            });
                        } else if (ret.eventType == "click") {
                            photoBrowser.close();
                        } else if (ret.eventType == "longPress") {
                            api.download({
                                url: images[ret.index],
                                report: true,
                                cache: true,
                                allowResume: true
                            }, function (ret, err) {
                                if (ret.percent == 100) {
                                    api.saveMediaToAlbum({
                                        path: ret.savePath
                                    }, function (albumret, albumreterr) {
                                        if (albumret && albumret.status) {
                                            api.toast({
                                                msg: "保存成功!",
                                                duration: 1000,
                                                location: 'middle'
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    });
                    photoBrowser.setIndex({
                        index: index
                    });
                });
            }

            function isfans(userid) {
                api.ajax({
                        url: CONFIG.ADDRURL + CONFIG.ISFANS,
                        method: 'post',
                        data: {
                            values: {
                                userid: userid,
                                fansid: $api.getStorage('userid')
                            }
                        }
                    },
                    function (isfans, err) {
                        if (isfans.isfans) {
                            //已关注
                            $(".DynamicDetailsTopR").html("已关注");
                            $(".DynamicDetailsTopR").css({
                                "color": "#999",
                                "background": "#eee",
                            });
                        } else {
                            $(".DynamicDetailsTopR").html("+&nbsp;关注");
                            $(".DynamicDetailsTopR").css({
                                "color": "#fff",
                                "background": "#ff9694",
                            });
                        }
                        $(".DynamicDetailsTopR").click(function () {
                            if (!checklogin()) {
                                return false;
                            }
                            api.ajax({
                                    url: CONFIG.ADDRURL + CONFIG.FANS,
                                    method: 'post',
                                    data: {
                                        values: {
                                            userid: userid,
                                            fansuserid: $api.getStorage('userid')
                                        }
                                    }
                                },
                                function (data, err) {
                                    if (data.code == "200") {
                                        if ($(".DynamicDetailsTopR").text().indexOf("已关注") >= 0) {
                                            $(".DynamicDetailsTopR").html("+&nbsp;关注");
                                            $(".DynamicDetailsTopR").css({
                                                "color": "#fff",
                                                "background": "#ff9694",
                                            });
                                        } else {
                                            $(".DynamicDetailsTopR").html("已关注");
                                            $(".DynamicDetailsTopR").css({
                                                "color": "#999",
                                                "background": "#eee",
                                            });
                                        }
                                    } else {
                                        api.toast({
                                            msg: data.msg,
                                            duration: 1000,
                                            location: 'middle'
                                        });
                                    }
                                });
                        });
                    });
            }

            function isdianzan(momentid) {
                var json = {
                    momentid: momentid,
                    userid: $api.getStorage('userid'),
                    isOffical: 1
                }

                // console.log(momentid)

                api.ajax({
                        url: CONFIG.ADDRURL + CONFIG.ISDIANZANMOMENT,
                        method: 'post',
                        data: {
                            values: json
                        }
                    },
                    function (isdianzan, err) {
                        if (isdianzan.isdianzan) {
                            $("#dianzan").find("img").attr("src", "../../images/SquarePL_09.png").attr(
                                "isdianzan", "true");
                        } else {
                            $("#dianzan").find("img").attr("src", "../../images/SquarePL_07.png").attr(
                                "isdianzan", "false");
                        }
                    });
            }


            //获取全部评论一级
            function getcomentslist(id, pagesize, pagenum, isclear) {
                if (isclear) {
                    $("#Comment").empty();
                }
                api.ajax({
                        url: CONFIG.ADDRURL + CONFIG.GFHDPL,
                        method: 'post',
                        data: {
                            values: {
                                activityid: id,
                                pagesize: pagesize,
                                pagenum: pagenum,
                                commenttype: 2
                            }
                        }
                    },
                    function (data) {
                        // console.log(JSON.stringify(data));
                        if (data.code == "200" && data.comments != null && data.comments.list.length > 0) {
                            pinlunPageNum = data.comments.nextPage;
                            pinlunHasNext = data.comments.hasNextPage;
                            $.each(data.comments.list, function (key, val) {
                                val.createtime = timestampToTime(val.createtime);
                                val.replycreatetime = timestampToTime(val.replycreatetime);
                            });
                            var tempFn = doT.template($api.byId('pinluntemplate').innerHTML);
                            var resultHTML = tempFn(data.comments.list);
                            $("#Comment").append(resultHTML);
                            $('#pinluncount').text(data.comments.total)
                        }
                    });
            };

            function getdianzan(id, pagesize, pagenum, isclear, func) {
                if (isclear) {
                    $("#Attention").empty();
                }
                api.ajax({
                        url: CONFIG.ADDRURL + CONFIG.GFHDPL,
                        method: 'post',
                        data: {
                            values: {
                                activityid: id,
                                pagesize: pagesize,
                                pagenum: pagenum,
                                commenttype: 1
                            }
                        }
                    },
                    function (data) {
                        console.log("------------------")
                        console.log(JSON.stringify(data))
                        if (data.code == "200" && data.comments != null) {


                            dianzanPageNum = data.comments.nextPage;
                            dianzanHasNext = data.comments.hasNextPage;
                            $.each(data.comments.list, function (key, val) {
                                val.replycreatetime = timestampToTime(val.replycreatetime);
                            });
                            var tempFn = doT.template($api.byId('dianzantemplate').innerHTML);
                            var resultHTML = tempFn(data.comments.list);
                            $("#Attention").append(resultHTML);
                            if (func) {
                                func(data.comments.total)
                            }
                        }

                    });
            };

            function checklogin() {
                var userinfo = $api.getStorage('userid');
                if (userinfo == null || userinfo == "") {
                    api.toast({
                        msg: '请先登录！',
                        duration: 1000,
                        location: 'middle'
                    });
                    api.openWin({
                        name: 'login',
                        url: '../../login.html',
                        bgColor: "rgba(255, 255, 255, 0)",
                        animation: {
                            type: "push", //动画类型（详见动画类型常量）
                            subType: "from_right", //动画子类型（详见动画子类型常量）
                            duration: 300 //动画过渡时间，默认300毫秒
                        }
                    });
                    return false;
                }
                return true;
            }
        }
    </script>

    <script type="text/template" id="pinluntemplate">
        {{~it:value:index}}
        <ul>
            <li class="DetailsListUL otherspage" userid="{{=value.replyuserid}}">
                <img src="{{?value.replyavatar}}{{=value.replyavatar}}{{??}}../../images/avatar.png{{?}}" />
            </li>
            <li class="DetailsListUR">
                <ul class="DetailsListURT otherspage" userid="{{=value.replyuserid}}">
                    <li>{{=value.replynickname}}</li>
                    <li></li>
                </ul>
                <div class="DLURCenter otherspage" userid="{{=value.replyuserid}}">
                    {{=value.replycommentcontent}}
                </div>
                <div class="DLURComment">
                    <div class="DLURCommentL">
                        {{=value.replycreatetime}}
                    </div>
                    <ul class="DLURCommentC">
                        <li commentid="{{=value.replyid}}" class="DLURCommentCL zidianzan">
                            <img isdianzan="{{=value.dianzan}}" src="{{?1==value.dianzan}}../../images/SquarePL_09.png{{??}}../../images/SquarePL_07.png{{?}}" />
                        </li>
                        <li class="DLURCommentCR">
                            {{=value.dianzancount}}
                        </li>
                    </ul>
                    <ul class="DLURCommentR">
                        <li commentid="{{=value.replymomentid}}" replyid="{{=value.replyid}}" class="DLURCommentCL zipinlun">
                            <img src="../../images/SquarePL_05.png" />
                        </li>
                        <li class="DLURCommentCR">
                            {{=value.pinluncount}}
                        </li>
                    </ul>
                </div>
                <!-- {{?value.commentcontent}} -->
                <div>
                    <ul>
                        <li class="DetailsListUR">
                            <ul class="DetailsListURT">
                                <li><img userid="{{=value.userid}}" class="otherspage" src="{{?value.avatar}}{{=value.avatar}}{{??}}../../images/avatar.png{{?}}" /></li>
                                <li>@{{=value.nickname}}</li>
                                <li></li>
                            </ul>
                            <div class="DLURCenter">
                                {{=value.commentcontent}}
                            </div>
                            <div class="DLURComment">
                                <div class="DLURCommentL">
                                    {{=value.createtime}}
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <!-- {{?}} -->
            </li>
        </ul>
        {{~}}
    </script>
    <script>
        intervalId = setInterval(function () {
            $('.textColor3').html(getCountDown($('.textColor3').attr('data-time')));
        }, 200);
    </script>
    <script type="text/javascript" src="../../script/timeChange.js"></script>
    <script type="text/template" id="Vdetails">
        <div class="VdetailsOne">
            <div class="VdetailsOneLeft">
                <img class="VdetailsOneLeftImg" src="{{=it.img}}" />
            </div>
            <div class="VdetailsOneRight">
                <div class="VdetailsOneRightOne">{{=it.activity_title}}</div>
                <div class="VdetailsOneRightTwo">{{=formatDuring (Date.parse(new Date())/1000-it.create_time)}}前发布</div>
                <!-- {{=getCountDown(it.activity_end_time)}}{{=it.activity_end_time}} -->
                <div class="VdetailsOneRightThree"><span class="textColor1">报名剩余时间:</span><span  data-time="{{=it.activity_end_time}}" class="textColor3">{{=getCountDown(it.activity_end_time)}}</span></div>
                <div class="VdetailsOneRightFour">
                  {{? it.isjoin != "1"}}
                  <p class="VenjoyBtn" activityId="{{=it.id}}">立即参加</p>
                  {{??}}
                  <p class="VenjoyBtn">已报名</p>
                  {{?}}

                  <p class="share" activityId="{{=it.id}}">分享</p>
                    <!-- <span class="Vjubao report" activityId="{{=it.id}}">举报</span> -->
                </div>
            </div>
        </div>
        <div class="VdetailsTwoTwo">
            <div class="VdetailsTwoText1">参与人数</div>
            <div class="VdetailsTwoText2"><span>{{=it.user_count}}</span>人要参加</div>
        </div>
        <div class="VdetailsTwoThree">
            <div class="VdetailsTwoText1">活动详情</div>
            <div class="VdetailsTwoThreeContent">
                {{=it.activity_content}}
            </div>
        </div>
    </script>
    <script type="text/template" id="dianzantemplate">
        {{~it:value:index}}
        <ul userid="{{=value.replyuserid}}" class="otherspage">
            <li class="DetailsListUL">
                <img src="{{?value.replyavatar}}{{=value.replyavatar}}{{??}}../../images/avatar.png{{?}}" />
            </li>
            <li class="DetailsListUR">
                <ul class="DetailsListURT">
                    <li>{{=value.replynickname}}</li>
                    <li></li>
                </ul>
                <div class="DLURComment">
                    <div class="DLURCommentL">
                        {{=value.replycreatetime}}
                    </div>
                    <!-- <ul class="DLURCommentC">
                        <li class="DLURCommentCL">
                            <img src="../../images/SquarePL_07.png" />
                        </li>
                        <li class="DLURCommentCR">
                            0
                        </li>
                    </ul> -->
                </div>
            </li>
        </ul>
        {{~}}
    </script>


</body>

</html>
